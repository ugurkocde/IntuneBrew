name: Send Weekly Fleet Reports

on:
  # Run every Monday at 8:00 AM UTC
  schedule:
    - cron: '0 8 * * 1'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  send-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Send Weekly Fleet Reports
        run: |
          echo "Triggering weekly fleet reports..."

          # Use INTUNEBREW_API_URL if set, otherwise default to production
          API_BASE_URL="${INTUNEBREW_API_URL:-https://intunebrew.com/api}"

          RESPONSE=$(curl -sL -w "\n%{http_code}" -X POST "${API_BASE_URL}/weekly-reports/send" \
            -H "Authorization: Bearer ${{ secrets.NOTIFICATIONS_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"trigger": "github_actions_scheduled"}')

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          # Extract response body (all but last line)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response status: $HTTP_CODE"
          echo "Response body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Weekly reports triggered successfully"

            # Parse and display results
            REPORTS_SENT=$(echo "$BODY" | grep -o '"reportsSent":[0-9]*' | grep -o '[0-9]*' || echo "0")
            TOTAL_ATTEMPTED=$(echo "$BODY" | grep -o '"totalAttempted":[0-9]*' | grep -o '[0-9]*' || echo "0")

            echo "Reports sent: $REPORTS_SENT of $TOTAL_ATTEMPTED"
          else
            echo "Failed to trigger weekly reports"
            exit 1
          fi
        env:
          INTUNEBREW_API_URL: ${{ secrets.INTUNEBREW_API_URL }}
          NOTIFICATIONS_API_KEY: ${{ secrets.NOTIFICATIONS_API_KEY }}
