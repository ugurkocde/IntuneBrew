name: Approve App Request

on:
  issue_comment:
    types: [created]

# Queue approvals - only one can run at a time
concurrency:
  group: approve-app-request
  cancel-in-progress: false

jobs:
  approve-app:
    # Only run if comment contains "/approve"
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      actions: write

    steps:
      - name: Check user permission
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const repoOwner = context.repo.owner;

            // Only the repository owner can use /approve
            if (commenter.toLowerCase() !== repoOwner.toLowerCase()) {
              core.setFailed(`Only the repository owner can approve app requests. User: ${commenter}`);
              return;
            }

      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Post progress comment
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Processing App Request\n\n- [ ] Validating apps on Homebrew\n- [ ] Adding to supported apps list\n- [ ] Committing changes\n- [ ] Triggering build workflow`
            });
            core.setOutput('comment_id', comment.id);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Add app to list
        id: add-app
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: python .github/scripts/add_new_app.py

      - name: Commit changes
        if: steps.add-app.outputs.app_added == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/scripts/collect_app_info.py
          git commit -m "Add ${{ steps.add-app.outputs.commit_message }}"
          git push

      # Build is auto-triggered by push to main (collect_app_info.py change)

      - name: Comment success
        if: steps.add-app.outputs.app_added == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const appsJson = `${{ steps.add-app.outputs.apps_json }}`;
            const commentId = ${{ steps.progress.outputs.comment_id }};

            let apps = [];
            try {
              apps = JSON.parse(appsJson);
            } catch (e) {
              // Fallback for single app
              apps = [{
                name: '${{ steps.add-app.outputs.app_name }}',
                cask: '${{ steps.add-app.outputs.cask_name }}',
                type: '${{ steps.add-app.outputs.app_type }}'
              }];
            }

            let body = `## Approved\n\n`;
            body += `- [x] Validating apps on Homebrew\n`;
            body += `- [x] Adding to supported apps list\n`;
            body += `- [x] Committing changes\n`;
            body += `- [x] Triggering build workflow\n\n`;

            if (apps.length === 1) {
              body += `**${apps[0].name}** has been added to IntuneBrew.\n\n`;
            } else {
              body += `**${apps.length} apps** have been added to IntuneBrew:\n\n`;
            }

            body += `| App Name | Cask | Type |\n|----------|------|------|\n`;
            let hasPkg = false;
            for (const app of apps) {
              body += `| ${app.name} | \`${app.cask}\` | \`${app.type}\` |\n`;
              if (app.type === 'pkg') hasPkg = true;
            }

            if (hasPkg) {
              body += `\n> **Note:** If the build fails for PKG apps, they may be PKG-in-PKG. Move them from \`pkg_urls\` to \`pkg_in_pkg_urls\` in \`collect_app_info.py\`.\n`;
            }

            body += `\nThe build has been triggered. Track progress: [Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/build-app-packages.yml)`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

      - name: Close issue
        if: steps.add-app.outputs.app_added == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: [...context.payload.issue.labels.map(l => l.name), 'approved']
            });

      - name: Comment failure
        if: failure() || steps.add-app.outputs.app_added == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const error = `${{ steps.add-app.outputs.error_message }}` || 'Unknown error';
            const commentId = ${{ steps.progress.outputs.comment_id || 0 }};

            const body = `## Failed to Add App\n\n- [x] Validating app on Homebrew\n- [ ] Adding to supported apps list\n- [ ] Committing changes\n- [ ] Triggering build workflow\n\n**Error:** ${error}\n\nPlease check the issue and try again.`;

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Update reaction
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const succeeded = '${{ steps.add-app.outputs.app_added }}' === 'true';

            // Remove eyes reaction
            try {
              const reactions = await github.rest.reactions.listForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id
              });

              for (const r of reactions.data) {
                if (r.content === 'eyes' && r.user.login === 'github-actions[bot]') {
                  await github.rest.reactions.deleteForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    reaction_id: r.id
                  });
                }
              }
            } catch (e) {}

            // Add final reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: succeeded ? 'rocket' : 'confused'
            });
